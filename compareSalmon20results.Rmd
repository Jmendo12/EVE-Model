---
title: "Comparison with original EVE results (salmon20)"
output:
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ape)

source('./scripts/eve-io.R')
source('./scripts/dvdt.R')

library(tidyverse)
```

## Beta shared test on first 20 genes of the salmonid expression data

Compare beta-shared test results with the original EVE implementation using the first 20 genes of the salmonid expression data. 

```{r Load data}
# simulated example data
tree <- read.tree("data/comparison/newFormat/salmonData/salmonidsPhylo.newick")
gene.data <- getExprData("data/comparison/newFormat/salmonData/salmon20.tsv")

# original EVE results
indivBetaMLparams <- read.table("data/comparison/oldEVE/results/indivBetaMLparams_salmon20.res", 
                                col.names = c("theta","sigma2","alpha","beta"))
sharedBetaMLparams <- read.table("data/comparison/oldEVE/results/sharedBetaMLparams_salmon20.res", 
                                 col.names = c("theta","sigma2","alpha","beta"))
betaTestLRTs <- scan("data/comparison/oldEVE/results/betaTestLRTs_salmon20.res")
sharedBetaMLs <- scan("data/comparison/oldEVE/results/sharedBetaMLs_salmon20.res")
indivBetaMLs <- scan("data/comparison/oldEVE/results/indivBetaMLs_salmon20.res")
```

```{r Run beta-shared test, cache=TRUE, include=F}
BetaSharedRes <- betaSharedTest(tree, gene.data)
```

```{r defPlotFun}
myCompareParamPlot <- function(df){
  df %>% 
    mutate( Parameter = factor(Parameter,levels=unique(Parameter))) %>% 
    mutate( geneID = factor(geneID,levels=rev(unique(geneID)))) %>% 
    ggplot( aes(x=Value,y=geneID, color=implementation, shape=implementation)) + 
    geom_point( size=3) + 
    scale_shape_manual(values = c(3,4)) +
    scale_x_log10() +
    facet_grid(. ~ Parameter ,scales = "free") +
    theme(legend.position="bottom")
}
```

### Beta shared estimate

* old: `r sharedBetaMLparams$beta[1]`
* new: `r BetaSharedRes$sharedBeta`

### LRTs

```{r plotLRT, fig.height=4, message=FALSE}
bind_rows( .id="implementation",
  old=tibble( LRT=betaTestLRTs, geneID=rownames(gene.data)),
  new=tibble( LRT=BetaSharedRes$LRT, geneID=rownames(gene.data))) %>% 
  gather(key = "Parameter",value = "Value", -implementation, -geneID) %>%
  myCompareParamPlot() +
  geom_vline(data=tibble(x=qchisq(p=0.95,df=1),Parameter="LRT"),aes(xintercept=x),color="blue",linetype=3) +
  geom_vline(data=tibble(x=qchisq(p=0.05,df=1),Parameter="LRT"),aes(xintercept=x),color="blue",linetype=3) +
  scale_x_continuous()
```

Vertical lines are 0.05 and 0.95 of chi-squared distribution with 1 degree of freedom.

### MLs

```{r plotMLs, fig.height=4}
bind_rows( .id="implementation",
  old=tibble( indivBetaML=indivBetaMLs,sharedBetaML=sharedBetaMLs, geneID=rownames(gene.data)),
  new=tibble( indivBetaML=-map_dbl(BetaSharedRes$indivBetaRes,"value"),sharedBetaML=-map_dbl(BetaSharedRes$sharedBetaRes,"value"), geneID=rownames(gene.data))) %>% 
  gather(key = "Parameter",value = "Value", -implementation, -geneID) %>%
  mutate( geneID = factor(geneID,levels=rev(unique(geneID)))) %>% 
  ggplot( aes(x=Value,y=geneID, color=implementation, shape=implementation)) + 
  geom_point( size=3) + 
  scale_shape_manual(values = c(3,4)) +
  # scale_x_log10() +
  facet_grid(. ~ Parameter ,scales = "free") +
  theme(legend.position="bottom")
```



### individual beta parameters

```{r plotCompareIndivBetaParams, fig.height=4, message=F}
alphaMax <- -log(.01) / min(tree$edge.length[tree$edge[,2] <= Ntip(tree)])

bind_rows(.id = "implementation",
          new=map_df(BetaSharedRes$indivBetaRes, ~ as_tibble(t(.x$par))) %>% 
            mutate( geneID = rownames(gene.data)),
          old=indivBetaMLparams %>% 
            mutate( geneID = rownames(gene.data))) %>% 
  gather(key = "Parameter",value = "Value", -implementation, -geneID) %>%
  filter( Parameter != "theta") %>% 
  myCompareParamPlot() +
  geom_vline(data=tibble(x=alphaMax,Parameter="alpha"),aes(xintercept=x),color="red",linetype=2)

bind_rows(.id = "implementation",
          new=map_df(BetaSharedRes$indivBetaRes, ~ as_tibble(t(.x$par))) %>% 
            mutate( geneID = rownames(gene.data)),
          old=indivBetaMLparams %>% 
            mutate( geneID = rownames(gene.data))) %>% 
  gather(key = "Parameter",value = "Value", -implementation, -geneID) %>%
  filter( Parameter == "theta") %>% 
  myCompareParamPlot() +
  scale_x_continuous()
```

### shared beta parameters

```{r plotCompareSharedBetaParams, fig.height=4, message=FALSE}
bind_rows(.id = "implementation",
          new=map_df(BetaSharedRes$sharedBetaRes, ~ as_tibble(t(.x$par))) %>% 
            mutate( geneID = rownames(gene.data)),
          old=sharedBetaMLparams %>% 
            mutate( geneID = rownames(gene.data))) %>% 
  gather(key = "Parameter",value = "Value", -implementation, -geneID) %>%
  filter( Parameter != "beta") %>% 
  filter( Parameter != "theta") %>% 
  myCompareParamPlot() +
  geom_vline(data=tibble(x=alphaMax,Parameter="alpha"),aes(xintercept=x),color="red",linetype=2)

bind_rows(.id = "implementation",
          new=map_df(BetaSharedRes$sharedBetaRes, ~ as_tibble(t(.x$par))) %>% 
            mutate( geneID = rownames(gene.data)),
          old=sharedBetaMLparams %>% 
            mutate( geneID = rownames(gene.data))) %>% 
  gather(key = "Parameter",value = "Value", -implementation, -geneID) %>%
  filter( Parameter == "theta") %>% 
  myCompareParamPlot() +
  scale_x_continuous()

```

